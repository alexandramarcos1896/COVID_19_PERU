---
title: "Propagacion"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

# Monitoreo de casos

```{r Librerias, echo=FALSE, message=FALSE}
library(rio)
library(gridExtra)
library(kableExtra)
library(JLutils) # devtools::install_github("larmarange/JLutils")
library(tidyverse)
library(cowplot)
library(sf)
library(dplyr)
library(ggrepel)
library(readxl)
library(cowplot)
library(ggpubr)
```


```{r Librerias, echo=FALSE, message=FALSE}
library(ggiraph)
library(directlabels)
library(dplyr) ## Necesario!
library(readr) ## Necesario!
library(ggplot2) ## Necesario!
library(lubridate)## Necesario!
library(purrr) ## Necesario
library(MMWRweek) ## Necesario
library(covidPeru)
#data=import("reportes_minsa.xlsx")
data=import("ReporteMinsaDepartamento.xlsx")
#devtools::install_github("jincio/covidPeru")
```


**Evolución de las tendencia de casos covid positivos**
```{r bases, echo=FALSE, message=FALSE}
sinadef <- da_sinadef()
positivos <- da_positivos()
fallecidos <- da_fallecidos()
```
**Nacional**
```{r positivos}
grafico1 <- casos_diarios(positivos)[[2]]
print(grafico1)
```

**Regional**
```{r positivos}
grafico2 <- casos_diarios(positivos,mediamovil = 3)[[2]]+ theme_bw() + scale_fill_manual(values = "#00AFBB") +
  scale_color_manual(values = "#FC4E07")
print(grafico2)
```

**Nacional**
```{r fallecidos}
grafico3 <- fallecidos_diarios(fallecidos,mediamovil = 7)[[2]] + theme_bw()+
  scale_fill_manual(values = "#00AFBB") +
  scale_color_manual(values = "#FC4E07")
print(grafico3)
```

**Crecimiento de los casos covid**
```{r crecimiento}
grafico5 <- casos_crecimiento(positivos,semanal = TRUE)[[2]] + theme_bw()
print(grafico5)
```

**Regional**

```{r crecimiento regional}
grafico6 <- casos_crecimiento(positivos,semanal = TRUE)[[2]] + theme_bw()
print(grafico5)
```

**Crecimiento fallecidos covid**

```{r fallecidos crecimiento}
grafico7 <-fallecidos_crecimiento(fallecidos,semanal = TRUE)[[2]]+theme_bw()
print(grafico7)
```

```{r fallecidos crecimiento regional}
grafico8 <- fallecidos_crecimiento(fallecidos, semanal = TRUE)[[2]] +theme_bw()
print(grafico8)
```


**Excesos de fallecidos a nivel Nacional**
```{r exceso de fallecidos nacional, message=FALSE}
grafico9 <- exceso_muertes(sinadef,metodo = TRUE)[[2]]+ theme_bw()+
  theme(legend.position = "top")
print(grafico9)
```

**Exceso de fallecido regional**

```{r exceso fallecidos regional, message=FALSE}
#grafico10 <-

```

**Mapa de calor del Exceso de Fallecido a nivel distrital**  
```{r mapa calor}
grafico11 <- panel_exceso(sinadef)
print(grafico11)
```

**Piramide por sexo y edad**  

*Distribución de los fallecidos covid por sexo y edad a nivel nacional*
```{r piramide nacional}
grafico12 <- piramide_fcovid(fallecidos)[[2]] +theme_bw()
print(grafico12)
```

*Distribucion de fallecidos por sexo y edad a nivel regional*
```{r piramide regional1}
a<-data.frame(dep = unique(fallecidos$DEPARTAMENTO)[1:6]) %>%
    dplyr::mutate(piramide = purrr::map(.x = dep, .f = ~piramide_fcovid(fallecidos, .x)[1] %>%as.data.frame())) %>%
    tidyr::unnest(cols = c(piramide))

grafico13 <- a %>%
      dplyr::mutate(n = ifelse(SEXO=="FEMENINO",
                        -n, n)) %>%
      ggplot2::ggplot(aes(x = EDAD_CAT,
                 y = n,
                 fill = SEXO,
                 label = abs(n))) +
      ggplot2::geom_col(position = "stack", alpha = 0.6) +
      ggplot2::geom_text(size = 3, check_overlap = TRUE)+
      ggplot2::scale_y_continuous(labels = abs) +
      ggplot2::labs(x = "Edad", y = "Numero de fallecidos", title = "Distribucion nacional de fallecimientos COVID-19 \n por edad y sexo") +
      ggplot2::scale_fill_manual(values = c("orange", "darkblue")) +
      ggplot2::coord_flip()+ facet_wrap(~dep, scales = "free")+
  theme(legend.position = "top")

print(grafico13)
```


```{r piramide regional2}
a<-data.frame(dep = unique(fallecidos$DEPARTAMENTO)[10:15]) %>%
    dplyr::mutate(piramide = purrr::map(.x = dep, .f = ~piramide_fcovid(fallecidos, .x)[1] %>%as.data.frame())) %>%
    tidyr::unnest(cols = c(piramide))

grafico14 <- a %>%
      dplyr::mutate(n = ifelse(SEXO=="FEMENINO",
                        -n, n)) %>%
      ggplot2::ggplot(aes(x = EDAD_CAT,
                 y = n,
                 fill = SEXO,
                 label = abs(n))) +
      ggplot2::geom_col(position = "stack", alpha = 0.6) +
      ggplot2::geom_text(size = 3, check_overlap = TRUE)+
      ggplot2::scale_y_continuous(labels = abs) +
      ggplot2::labs(x = "Edad", y = "Numero de fallecidos", title = "Distribucion nacional de fallecimientos COVID-19 \n por edad y sexo") +
      ggplot2::scale_fill_manual(values = c("orange", "darkblue")) +
      ggplot2::coord_flip()+ facet_wrap(~dep, scales = "free")+
  theme(legend.position = "top")

print(grafico14)
```


*Distribución de casos positivos por sexo y edad a nivel nacional*
```{r piramide nacional covid}
grafico15 <- piramide_pcovid(positivos)[[2]] + theme_bw()
print(grafico15)
```

*Distribución de casos positivos por sexo y edad a nivel regional*
```{r piramide casos regional1}
a<-data.frame(dep = unique(positivos$DEPARTAMENTO)[1:4]) %>%
    dplyr::mutate(piramide = purrr::map(.x = dep, .f = ~piramide_pcovid(positivos, .x)[1] %>%as.data.frame())) %>%
    tidyr::unnest(cols = c(piramide))

grafico14 <- a %>%
      dplyr::mutate(n = ifelse(SEXO=="FEMENINO",
                        -n, n)) %>%
      ggplot2::ggplot(aes(x = EDAD_CAT,
                 y = n,
                 fill = SEXO,
                 label = abs(n))) +
      ggplot2::geom_col(position = "stack", alpha = 0.6) +
      ggplot2::geom_text(size = 3, check_overlap = TRUE)+
      ggplot2::scale_y_continuous(labels = abs) +
      ggplot2::labs(x = "Edad", y = "Numero de positivos", title = "Distribucion nacional de positivos COVID-19 \n por edad y sexo") +
      ggplot2::scale_fill_manual(values = c("orange", "darkblue")) +
      ggplot2::coord_flip()+ facet_wrap(~dep, scales = "free")+
  theme(legend.position = "top")

print(grafico14)
```

```{r piramide casos regional2}
a<-data.frame(dep = unique(positivos$DEPARTAMENTO)[10:13]) %>%
    dplyr::mutate(piramide = purrr::map(.x = dep, .f = ~piramide_pcovid(positivos, .x)[1] %>%as.data.frame())) %>%
    tidyr::unnest(cols = c(piramide))

grafico15 <- a %>%
      dplyr::mutate(n = ifelse(SEXO=="FEMENINO",
                        -n, n)) %>%
      ggplot2::ggplot(aes(x = EDAD_CAT,
                 y = n,
                 fill = SEXO,
                 label = abs(n))) +
      ggplot2::geom_col(position = "stack", alpha = 0.6) +
      ggplot2::geom_text(size = 3, check_overlap = TRUE)+
      ggplot2::scale_y_continuous(labels = abs) +
      ggplot2::labs(x = "Edad", y = "Numero de positivos", title = "Distribucion nacional de positivos COVID-19 \n por edad y sexo") +
      ggplot2::scale_fill_manual(values = c("orange", "darkblue")) +
      ggplot2::coord_flip()+ facet_wrap(~dep, scales = "free")+
  theme(legend.position = "top")

print(grafico15)
```

**Modelo SIRD**

```{r resultado sird,echo=FALSE}
resultados <- sird_villaverde(sinadef,"lima")
```


*Evolucion del R0*
```{r r0}
r0 <- resultados[["R0"]]

```


*Evolución del Número de fallecidos*




# Responsables 

Colaboran para la elaboración de los gráficos:

- Francisco Rodríguez
- Gabriel Carrasco
- Joan Martinez
- José Incio
- Samuel Calderon


